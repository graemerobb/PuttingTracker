name: Deploy PuttingTracker (static)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to droplet via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -euo pipefail

            APP_DIR=/home/robbg/apps/puttingtracker
            WEB_ROOT=/home/robbg/truetargetputting.com/public_html/puttingtracker

            cd "$APP_DIR"
            GIT_SSH_COMMAND="ssh -i ~/.ssh/puttingtracker_deploy -o IdentitiesOnly=yes" git pull

            mkdir -p "$WEB_ROOT" "$WEB_ROOT/api" "$WEB_ROOT/data"

            # Deploy static files first
            rsync -av --delete \
                --exclude 'api/' \
                --exclude 'data/' \
                "$APP_DIR/public/" "$WEB_ROOT/"

            # Now cache-bust the DEPLOYED html (not the git-tracked source)
            VERSION="$(date +%Y%m%d_%H%M)"
            
            #HTML_FILE="$WEB_ROOT/index.html"
            #VERSION="$VERSION" perl -0777 -i -pe '
            #    my $v = $ENV{VERSION};
            #    s/(href="[^"]*styles\.css)(\?v=[^"]*)?"/$1?v=$v"/g;
            #    s/(src="[^"]*app\.js)(\?v=[^"]*)?"/$1?v=$v"/g;
            #' "$HTML_FILE"

            HTML_FILES=(
              "$WEB_ROOT/index.html"
              "$WEB_ROOT/stats/dash.html"
            )
            for f in "${HTML_FILES[@]}"; do
              VERSION="$VERSION" perl -0777 -i -pe '
                my $v = $ENV{VERSION};
                s/(href="[^"]*styles\.css)(\?v=[^"]*)?"/$1?v=$v"/g;
                s/(src="[^"]*app\.js)(\?v=[^"]*)?"/$1?v=$v"/g;
              ' "$f"
            done

            # Deploy API
            rsync -av --delete "$APP_DIR/api/" "$WEB_ROOT/api/"

            echo "Deployed PuttingTracker to $WEB_ROOT (v=$VERSION)"
