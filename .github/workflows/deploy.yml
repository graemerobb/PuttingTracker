name: Deploy PuttingTracker (static)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to droplet via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -euo pipefail

            APP_DIR=/home/robbg/apps/puttingtracker
            WEB_ROOT=/home/robbg/truetargetputting.com/public_html/puttingtracker

            cd "$APP_DIR"
            GIT_SSH_COMMAND="ssh -i ~/.ssh/puttingtracker_deploy -o IdentitiesOnly=yes" git pull

            # Ensure folders exist BEFORE rsync
            mkdir -p "$WEB_ROOT" "$WEB_ROOT/api" "$WEB_ROOT/data"

            # 1) Deploy frontend, but DO NOT delete api/ or data/ on the server
            rsync -av --delete \
                --exclude 'api/' \
                --exclude 'data/' \
                "$APP_DIR/public/" "$WEB_ROOT/"

            # 2) Deploy API PHP files
            rsync -av --delete "$APP_DIR/api/" "$WEB_ROOT/api/"

            # 3) Deploy control files into data/ (safe)
            rsync -av "$APP_DIR/data/.htaccess" "$WEB_ROOT/data/.htaccess"
            rsync -av "$APP_DIR/data/.gitignore" "$WEB_ROOT/data/.gitignore"

            # 4) Ensure the JSONL store exists and persists
            touch "$WEB_ROOT/data/sessions.jsonl"

            echo "Deployed PuttingTracker to $WEB_ROOT"

