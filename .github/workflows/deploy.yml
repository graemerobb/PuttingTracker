name: Deploy PuttingTracker (static)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to droplet via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -euo pipefail

            # Paths
            APP_DIR=/opt/apps/puttingtracker
            WEB_ROOT=/path/to/top-level/public_html/puttingtracker

            # Pull latest
            cd "$APP_DIR"
            GIT_SSH_COMMAND="ssh -i ~/.ssh/puttingtracker_deploy -o IdentitiesOnly=yes" git pull

            # Ensure folders exist
            mkdir -p "$WEB_ROOT" "$WEB_ROOT/api" "$WEB_ROOT/data"

            # 1) Deploy frontend (root files)
            rsync -av --delete "$APP_DIR/public/" "$WEB_ROOT/"

            # 2) Deploy API PHP files
            rsync -av --delete "$APP_DIR/api/" "$WEB_ROOT/api/"

            # 3) Deploy ONLY control files into data/ (do NOT delete or overwrite sessions.jsonl)
            rsync -av "$APP_DIR/data/.htaccess" "$WEB_ROOT/data/.htaccess"
            rsync -av "$APP_DIR/data/.gitignore" "$WEB_ROOT/data/.gitignore"

            # 4) Ensure the JSONL store exists and persists
            touch "$WEB_ROOT/data/sessions.jsonl"

            echo "Deployed PuttingTracker to $WEB_ROOT"

