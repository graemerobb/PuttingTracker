name: Deploy PuttingTracker (static)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to droplet via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -euo pipefail

            APP_DIR=/home/robbg/apps/puttingtracker
            WEB_ROOT=/home/robbg/truetargetputting.com/public_html/puttingtracker

            cd "$APP_DIR"
            GIT_SSH_COMMAND="ssh -i ~/.ssh/puttingtracker_deploy -o IdentitiesOnly=yes" git pull

            VERSION="$(date +%Y%m%d_%H%M)"
            HTML_FILE="$APP_DIR/public/index.html"

            VERSION="$VERSION" perl -0777 -i -pe '
            my $v = $ENV{VERSION};
            s/(href="[^"]*styles\.css)(\?v=[^"]*)?"/$1?v=$v"/g;
            s/(src="[^"]*app\.js)(\?v=[^"]*)?"/$1?v=$v"/g;
            ' "$HTML_FILE"

            mkdir -p "$WEB_ROOT" "$WEB_ROOT/api" "$WEB_ROOT/data"

            rsync -av --delete \
                --exclude 'api/' \
                --exclude 'data/' \
                "$APP_DIR/public/" "$WEB_ROOT/"

            rsync -av --delete "$APP_DIR/api/" "$WEB_ROOT/api/"

            echo "Deployed PuttingTracker to $WEB_ROOT"